
@{
    ViewBag.Title = "DevIndex";
}
<script src="~/Scripts/jquery.min.js"></script>
<script src="~/Scripts/jquery.easyui.min.js"></script>
@*<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7/jquery.js"></script>*@
<script src="http://malsup.github.com/jquery.form.js"></script>

    <h2>Repository Development</h2>
<div id="uploadwindow" class="easyui-window" title="Upload Files" data-options="iconCls:'icon-upload',closed:true" style="width:500px;height:200px;padding:10px;">
    @using (Ajax.BeginForm(null, null, new AjaxOptions() { HttpMethod = "POST" }, new { enctype = "multipart/form-data" }))
    {
        <table>
            <tr>
                <td><input type="file" name="files" id="files" multiple /></td>
                <td><input type="submit" name="upload" value="Upload" id="upload" /></td>
                <td><input type="hidden" name="path" id="UploadPath" value=""></td>
            </tr>

        </table>
    }
    <div class="progress progress-striped" style="width:60%">
        <div style="color:blue" class="progress-bar progress-bar-success">0%</div>
    </div>

    <div id="status"></div>
</div>

    @Html.Partial("_FileBrowserPartial")
   
    
    <div id="CreateDirwindow" class="easyui-window" title="Create Directory" data-options="modal:true,closed:true,iconCls:'icon-folder'" style="width:500px;height:200px;padding:10px;">
        <div style="margin-bottom:2px">
            Folder Name:
            <input class="easyui-textbox" id="FolderN" style="width:50%;height:25px;margin-left:5px">
            <a href="#" class="easyui-linkbutton"  data-options="iconCls:'icon-ok'" onclick="CreateConfirm()">Create</a>
        </div>
        
            
        
    </div>
    <script>
        function Upload() {
            var Folder = $("#filestree").treegrid("getSelections");           
            if (Folder.length != 0) {
                if (Folder[0].Size != "")
                    Folder = $("#filestree").treegrid('getParent', Folder[0].id);
                else Folder = Folder[0];
                Folder = Folder.FullPath;
                $('#UploadPath').val(Folder);
            }
            
            $('#uploadwindow').window('open');
        }

        (function () {
            var bar = $('.progress-bar');
            var percent = $('.progress-bar');
            var status = $('#status');
            $('form').ajaxForm({
                beforeSend: function () {
                    status.empty();
                    var percentVal = '0%';
                    bar.width(percentVal)
                    percent.html(percentVal);
                },
                uploadProgress: function (event, position, total, percentComplete) {
                    var percentVal = percentComplete + '%';
                    bar.width(percentVal)
                    percent.html(percentVal);
                },

                success: function (mess) {
                    var percentVal = '100%';
                    bar.width(percentVal)
                    percent.html(percentVal);
                    status.html("<p style='color:red '>" + mess + "</p>");
                    $.messager.show({
                        title: 'Successful',
                        msg: 'Succeed to uploading files',
                        timeout: 5000,
                        showType: 'slide'
                    });
                    Refreshtree();
                },
                error: function (xhr) {
                    var percentVal = '0%';
                    bar.width(percentVal)
                    percent.html(percentVal);
                    status.html("<p style='color:red '>" + xhr.responseText + "</p>");
                    $.messager.show({
                        title: 'Error',
                        msg: 'Error',
                        timeout: 5000,
                        showType: 'slide'
                    });
                },

            });

        })();


       


        function DeleteDependency() {
            var rows = $('#denpendencytable').datagrid('getSelections');
            if (rows.length == 0) {
                $('#dlg').dialog('open');
                $('#dlg').html("Please choose at least one file.");
                $('#dlg-ok').bind('click', function () { Back(); });
                return;
            }
            var Postinfo = "";
            for (var i = 0; i < rows.length; i++) {
                var basicfile = rows[i].GBFullPath;
                var deletefile = rows[i].FullPath;
                Postinfo += basicfile + "::" + deletefile + ";";
            }
            $.ajax({
                url: '@Url.Action("DeleteDependency","Developers")' + "?files=" + Postinfo,

            })
        .done(function (data) {
            if (data == "Success") {
                $.messager.show({
                    title: 'Successful',
                    msg: 'Delete Denpendencies complete.',
                    timeout: 5000,
                    showType: 'slide'
                });

                $('#denpendencytable').datagrid('reload');
            }
            else {

                $.messager.show({
                    title: 'Error',
                    msg: 'Error. Try again.',
                    timeout: 5000,
                    showType: 'slide'
                });

            }
        });
        }


        function AddDependency() {
            var contents = '<div class="easyui-tabs" id="subtabs" data-options="fit:true,plain:true"><div title="Choose Files" ><table id="newdepentable" class="easyui-datagrid" title="Add Dependency" style="width:600px;height:500px"></table><div id="newdepentb"><a href="#" class="easyui-linkbutton" id="choosedepen" iconcls="icon-add" plain="true" onclick="ChooseDependency()">Choose Dependencies</a></div></div></div>';
            $('#tt').tabs({
                onAdd: function () {
                    $('#tt').tabs('disableTab', 0);
                },
                onClose: function () {
                    $('#tt').tabs('enableTab', 0);
                }
            });
            $('#tt').tabs('add', {
                title: 'Add Dependencies',
                content: contents,

                closable: true,
                iconCls: 'icon-add',
            });


            var rows = $('#denpendencytable').datagrid('getRows');
            var Postinfo = "";
            for (var i = 0; i < rows.length; i++) {
                var tmp = rows[i].GBFullPath;
                if (Postinfo.indexOf(tmp) == -1) {
                    Postinfo += tmp + ";";
                }
            }

            $('#newdepentable').datagrid({
                url: '@Url.Action("ShowFiles","Developers")' + "?files=" + Postinfo,
                columns: [[
                    { field: 'FileName', title: 'FileName', width: 100 },
                    { field: 'Size', title: 'Size', width: 100 },
                    { field: 'FullPath', title: 'FullPath', width: 300 },

                ]],

                toolbar: '#newdepentb',

                rownumbers: true,

            });

        }


        function ChooseDependency() {
            var rows = $('#newdepentable').datagrid('getSelections');
            if (rows.length == 0) {
                $('#dlg').dialog('open');
                $('#dlg').html("Please choose at least one file.");
                $('#dlg-ok').bind('click', function () { Back(); });
                return;
            }
            var contents = '<table title="Files Browser" class="easyui-treegrid" style="width:100%;height:500px" id="DependenciesTree"></table><div id="DependenciesTreetb"><a href="#" class="easyui-linkbutton" iconcls="icon-ok" plain="true" onclick="SpecifyDependencies()">Confirm</a></div>'
            $('#subtabs').tabs('add', {
                title: 'Choose Dependencies',
                content: contents,
                closable: true,
                iconCls: 'icon-add',
            });

            $("#DependenciesTree").treegrid({
                method: 'get',
                rownumbers: false,
                idField: 'id',
                treeField: 'FileName',
                url: '@Url.Action("Getjson", "NormalUsers")',
                columns: [[

                        {
                            title: 'FileName', field: 'FileName', width: 200
                        },
                        {
                            title: 'Size', field: 'Size', width: 100, align: 'center',

                        },
                        { title: 'FullPath', field: 'FullPath', width: 320 },
                ]],
                singleSelect: false,
                toolbar: '#DependenciesTreetb',

            });
        }

        function SpecifyDependencies() {
            var files = $('#newdepentable').datagrid('getSelections');
            var tmpurl = "";
            var depens = $("#DependenciesTree").treegrid('getSelections');
            for (var i = 0; i < files.length; i++) {
                tmpurl += files[i].FullPath + "|";
            }
            tmpurl += "::";
            for (var i = 0; i < depens.length; i++) {
                tmpurl += depens[i].FullPath + ";";
            }
            $.ajax({
                url: '@Url.Action("SpecifyDependency","Developers")' + "?files=" + tmpurl,

            })
           .done(function (data) {
               if (data == "Successful") {
                   $.messager.show({
                       title: 'Successful',
                       msg: 'Add Denpendencies complete.',
                       timeout: 5000,
                       showType: 'slide'
                   });
                   $('#tt').tabs('close', 'Add Dependencies');
                   $('#denpendencytable').datagrid('reload');
               }
           });
        }


        //Create Directory
        function CreateFolder() {

            $('#FolderN').textbox('setText', '');
            $('#CreateDirwindow').window('open');

        }

        function CreateConfirm() {
            var foldname = $('#FolderN').textbox('getText');
            var AllNumIsSame = new Array("’", "”", "。", ";", ":", "<", ">", "?", "|", "!", "#", "$", "%", "^", "&", "*", "(", ")", "+", "-", ".");
            for (var i = 0; i < AllNumIsSame.length; i++) {
                if (foldname.indexOf(AllNumIsSame[i]) != -1) {
                    $.messager.show({
                        title: 'Error',
                        msg: 'Error. Can not Contain ' + AllNumIsSame[i],
                        timeout: 5000,
                        showType: 'slide'
                    });
                    return;
                }
            }

            var ParentFolder = $("#filestree").treegrid("getSelections");
            var url = '@Url.Action("CreateDir", "Developers")';
            var path = "";
            if (ParentFolder.length != 0) {
                if (ParentFolder[0].Size != "")
                    ParentFolder = $("#filestree").treegrid('getParent', ParentFolder[0].id);
                else ParentFolder = ParentFolder[0];
                path = ParentFolder.FullPath;
            }
            
            if (path == "") url += "?foldername=" + foldname;
            else url += "?foldername=" + foldname + "&&path=" + path;
            $.ajax({
                url: url
            }).done(function (data) {
                if (data == "Error")
                    $.messager.show({
                        title: 'Error',
                        msg: 'Error. Maybe the directory name is already used.',
                        timeout: 5000,
                        showType: 'slide'
                    });
                else {
                    $('#CreateDirwindow').window('close');
                    $.messager.show({
                        title: 'Successful',
                        msg: 'Congratulations.Your folder has been created.',
                        timeout: 5000,
                        showType: 'slide'
                    });
                    Refreshtree();
                }
            });
        }
    </script>

